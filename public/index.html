<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Florr - Multiplayer Slayers</title>
    <style>
        body { margin: 0; background: #1a1a1a; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        #topStats { position: absolute; top: 10px; width: 100%; text-align: center; color: white; font-size: 22px; font-weight: bold; pointer-events: none; text-shadow: 2px 2px 4px #000; z-index: 10; }
        #inventory { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 110px; background: rgba(0,0,0,0.5); border: 2px solid #444; border-radius: 10px; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; pointer-events: none; }
        .slot { width: 40px; height: 40px; background: #222; border: 2px solid #555; border-radius: 5px; position: relative; overflow: hidden; }
        .reload-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: #3498db; height: 0%; }
        .overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #333; padding: 40px; border-radius: 20px; text-align: center; color: white; z-index: 100; border: 4px solid #444; width: 350px; }
        button { padding: 12px 30px; font-size: 20px; background: #2ecc71; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px; }
    </style>
</head>
<body>
    <!-- 1. SOCKET.IO LIBRARY -->
    <script src="https://cdn.socket.io"></script>

    <div id="topStats">Score: <span id="scoreVal">0</span> | Players: <span id="playerCount">1</span></div>
    <div id="inventory"></div>

    <div id="startMenu" class="overlay">
        <h1>MULTIPLAYER MODE</h1>
        <p>Your Link: my-multiplayer-game-kpdz.onrender.com</p>
        <button onclick="initGame()">JOIN WORLD</button>
    </div>

    <div id="gameOver" class="overlay" style="display:none;">
        <h1>YOU DIED</h1>
        <button onclick="location.reload()">RESTART</button>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const invDiv = document.getElementById('inventory');
    const scoreVal = document.getElementById('scoreVal');

    const WORLD_RADIUS = 1500, RELOAD_TIME = 30; 
    let player, mobs = [], otherPlayers = {}, socket, score, gameActive, isSprinting, isAttacking;
    let petals = [], petalAngle = 0, camera = { x: 0, y: 0 }, mouseX = 0, mouseY = 0;

    function initGame() {
        // 2. CONNECT TO YOUR SPECIFIC RENDER SERVER
        socket = io("https://my-multiplayer-game-kpdz.onrender.com"); 

        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        score = 0; gameActive = true; 
        
        player = { x: 0, y: 0, radius: 30, hp: 1000, maxHp: 1000, speed: 9, petalDistance: 40 };
        
        // Setup Petal UI
        petals = []; invDiv.innerHTML = '';
        for(let i=0; i<20; i++) {
            const slotUI = document.createElement('div'); slotUI.className = 'slot';
            const bar = document.createElement('div'); bar.className = 'reload-bar';
            slotUI.appendChild(bar); invDiv.appendChild(slotUI);
            petals.push({ active: true, timer: 0, ui: bar });
        }

        // 3. LISTEN FOR DATA FROM SERVER
        socket.on('tick', (data) => {
            otherPlayers = data.players;
            mobs = data.mobs;
            document.getElementById('playerCount').innerText = Object.keys(otherPlayers).length;
        });

        document.getElementById('startMenu').style.display = "none";
        requestAnimationFrame(gameLoop);
    }

    window.addEventListener('mousemove', (e) => { mouseX = e.clientX; mouseY = e.clientY; });
    window.addEventListener('keydown', (e) => { if (e.shiftKey) isSprinting = true; if (e.code === "Space") isAttacking = true; });
    window.addEventListener('keyup', (e) => { if (!e.shiftKey) isSprinting = false; if (e.code === "Space") isAttacking = false; });

    function gameLoop() {
        if (!gameActive || !socket) return;

        // 4. SEND YOUR POSITION TO SERVER
        socket.emit('update', { x: player.x, y: player.y, isAttacking: isAttacking });

        camera.x = player.x - canvas.width / 2;
        camera.y = player.y - canvas.height / 2;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save(); ctx.translate(-camera.x, -camera.y);

        // Draw Arena
        ctx.beginPath(); ctx.arc(0, 0, WORLD_RADIUS, 0, Math.PI*2);
        ctx.fillStyle = "#76c043"; ctx.fill();
        ctx.strokeStyle = "#558b2f"; ctx.lineWidth = 10; ctx.stroke();

        // Player Movement Logic
        let angle = Math.atan2(mouseY - canvas.height/2, mouseX - canvas.width/2);
        let moveX = Math.cos(angle) * (isSprinting ? player.speed * 1.8 : player.speed);
        let moveY = Math.sin(angle) * (isSprinting ? player.speed * 1.8 : player.speed);
        player.x += moveX; player.y += moveY;

        // 5. DRAW OTHER PLAYERS
        for (let id in otherPlayers) {
            if (id !== socket.id) {
                let p = otherPlayers[id];
                ctx.fillStyle = "rgba(255, 255, 255, 0.6)"; // White/Ghostly for others
                ctx.beginPath(); ctx.arc(p.x, p.y, 30, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = "white";
                ctx.font = "14px Arial";
                ctx.fillText("Other Player", p.x - 35, p.y - 45);
            }
        }

        // Draw Your Petals
        petalAngle += isAttacking ? 0.15 : 0.05;
        let targetDist = isAttacking ? 280 : 40;
        player.petalDistance = (player.petalDistance || 40) + (targetDist - player.petalDistance) * 0.1;

        petals.forEach((p, i) => {
            if (!p.active) {
                p.timer++; p.ui.style.height = (p.timer/RELOAD_TIME * 100) + "%";
                if (p.timer >= RELOAD_TIME) { p.active = true; p.timer = 0; p.ui.style.height = "0%"; }
                return;
            }
            let pAngle = petalAngle + (i * (Math.PI * 2 / petals.length));
            let px = player.x + Math.cos(pAngle) * player.petalDistance;
            let py = player.y + Math.sin(pAngle) * player.petalDistance;
            ctx.fillStyle = "#3498db"; ctx.beginPath(); ctx.arc(px, py, 15, 0, Math.PI * 2); ctx.fill();
        });

        // Draw You
        ctx.fillStyle = "#ffeb3b"; ctx.beginPath(); ctx.arc(player.x, player.y, player.radius, 0, Math.PI*2); ctx.fill();

        ctx.restore();
        requestAnimationFrame(gameLoop);
    }
</script>
</body>
</html>
