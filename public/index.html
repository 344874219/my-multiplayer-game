<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Florr Multiplayer Co-op</title>
    <style>
        body { margin: 0; background: #1a1a1a; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        #topStats { position: absolute; top: 10px; width: 100%; text-align: center; color: white; font-size: 22px; font-weight: bold; pointer-events: none; text-shadow: 2px 2px 4px #000; z-index: 10; }
        #waveText { position: absolute; top: 25%; left: 50%; transform: translate(-50%, -50%); font-size: 60px; color: #f1c40f; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 20; }
        #waveText.show { opacity: 1; }
        #inventory { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 110px; background: rgba(0,0,0,0.5); border: 2px solid #444; border-radius: 10px; padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; pointer-events: none; }
        .slot { width: 40px; height: 40px; background: #222; border: 2px solid #555; border-radius: 5px; position: relative; overflow: hidden; }
        .reload-bar { position: absolute; bottom: 0; left: 0; width: 100%; background: #3498db; height: 0%; }
        .overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #333; padding: 40px; border-radius: 20px; text-align: center; color: white; z-index: 100; border: 4px solid #444; width: 350px; }
        button { padding: 12px 30px; font-size: 20px; background: #2ecc71; color: white; border: none; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>
    <script src="https://cdn.socket.io"></script>
    <div id="topStats">Wave: <span id="waveVal">1</span> | Score: <span id="scoreVal">0</span> | Next: <span id="timerVal">3</span>s</div>
    <div id="waveText">WAVE 1</div>
    <div id="inventory"></div>
    <div id="startMenu" class="overlay"><h1>CO-OP ARENA</h1><button onclick="initGame()">JOIN WORLD</button></div>
    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const socket = io("https://my-multiplayer-game-kpdz.onrender.com");
    
    let player, otherPlayers = {}, mobs = [], gameActive = false, score = 0;
    let petals = [], petalAngle = 0, isSprinting = false, isAttacking = false, mouseX = 0, mouseY = 0;

    function initGame() {
        gameActive = true;
        document.getElementById('startMenu').style.display = "none";
        player = { x: 0, y: 0, radius: 35, hp: 5000, maxHp: 5000, petalDistance: 40 };
        for(let i=0; i<20; i++) {
            const bar = document.createElement('div'); bar.className = 'reload-bar';
            const slot = document.createElement('div'); slot.className = 'slot';
            slot.appendChild(bar); document.getElementById('inventory').appendChild(slot);
            petals.push({ active: true, timer: 0, ui: bar });
        }
        socket.on('tick', data => {
            otherPlayers = data.players;
            mobs = data.mobs;
            document.getElementById('waveVal').innerText = data.waveCount;
            document.getElementById('timerVal').innerText = data.waveTimer;
        });
        requestAnimationFrame(gameLoop);
    }

    window.addEventListener('mousemove', e => { mouseX = e.clientX; mouseY = e.clientY; });
    window.addEventListener('keydown', e => { if(e.shiftKey) isSprinting = true; if(e.code === "Space") isAttacking = true; });
    window.addEventListener('keyup', e => { if(!e.shiftKey) isSprinting = false; if(e.code === "Space") isAttacking = false; });

    function gameLoop() {
        if(!gameActive) return;

        // Sync with server
        socket.emit('update', { x: player.x, y: player.y, petalAngle: petalAngle, petalDist: player.petalDistance });

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save(); ctx.translate(canvas.width/2 - player.x, canvas.height/2 - player.y);

        // Arena
        ctx.beginPath(); ctx.arc(0, 0, 1500, 0, Math.PI*2); ctx.fillStyle = "#76c043"; ctx.fill();

        // Movement
        let angle = Math.atan2(mouseY - canvas.height/2, mouseX - canvas.width/2);
        player.x += Math.cos(angle) * (isSprinting ? 16 : 8);
        player.y += Math.sin(angle) * (isSprinting ? 16 : 8);

        // Draw Mobs
        mobs.forEach(m => {
            ctx.fillStyle = m.isBoss ? "black" : "red";
            ctx.beginPath(); ctx.arc(m.x, m.y, m.radius, 0, Math.PI*2); ctx.fill();
            // Health bar
            ctx.fillStyle = "black"; ctx.fillRect(m.x - m.radius, m.y - m.radius - 15, m.radius * 2, 8);
            ctx.fillStyle = "#2ecc71"; ctx.fillRect(m.x - m.radius, m.y - m.radius - 15, (m.radius * 2) * (m.hp/m.maxHp), 8);
        });

        // Draw Other Players
        for(let id in otherPlayers) {
            if(id === socket.id) continue;
            let p = otherPlayers[id];
            ctx.fillStyle = "rgba(255, 255, 255, 0.5)";
            ctx.beginPath(); ctx.arc(p.x, p.y, 35, 0, Math.PI*2); ctx.fill();
        }

        // Petals & Collision
        petalAngle += isAttacking ? 0.15 : 0.05;
        player.petalDistance += ((isAttacking ? 280 : 45) - player.petalDistance) * 0.1;

        petals.forEach((p, i) => {
            if(!p.active) {
                p.timer++; p.ui.style.height = (p.timer/30 * 100) + "%";
                if(p.timer >= 30) { p.active = true; p.timer = 0; p.ui.style.height = "0%"; }
                return;
            }
            let px = player.x + Math.cos(petalAngle + (i * Math.PI * 2 / 20)) * player.petalDistance;
            let py = player.y + Math.sin(petalAngle + (i * Math.PI * 2 / 20)) * player.petalDistance;
            ctx.fillStyle = "#3498db"; ctx.beginPath(); ctx.arc(px, py, 15, 0, Math.PI*2); ctx.fill();

            mobs.forEach(m => {
                if(Math.hypot(px - m.x, py - m.y) < 15 + m.radius) {
                    socket.emit('hitMob', { mobId: m.id });
                    p.active = false;
                }
            });
        });

        // Draw You
        ctx.fillStyle = "#ffeb3b"; ctx.beginPath(); ctx.arc(player.x, player.y, 35, 0, Math.PI*2); ctx.fill();

        ctx.restore();
        requestAnimationFrame(gameLoop);
    }
</script>
</body>
</html>
